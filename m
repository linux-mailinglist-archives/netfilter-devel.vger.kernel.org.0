Return-Path: <netfilter-devel-owner@vger.kernel.org>
X-Original-To: lists+netfilter-devel@lfdr.de
Delivered-To: lists+netfilter-devel@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id A5D8E75602E
	for <lists+netfilter-devel@lfdr.de>; Mon, 17 Jul 2023 12:13:32 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229563AbjGQKNb (ORCPT <rfc822;lists+netfilter-devel@lfdr.de>);
        Mon, 17 Jul 2023 06:13:31 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:34814 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230194AbjGQKNa (ORCPT
        <rfc822;netfilter-devel@vger.kernel.org>);
        Mon, 17 Jul 2023 06:13:30 -0400
Received: from mail-wm1-f54.google.com (mail-wm1-f54.google.com [209.85.128.54])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 291BA1BE
        for <netfilter-devel@vger.kernel.org>; Mon, 17 Jul 2023 03:13:27 -0700 (PDT)
Received: by mail-wm1-f54.google.com with SMTP id 5b1f17b1804b1-3fbc244d384so39229965e9.0
        for <netfilter-devel@vger.kernel.org>; Mon, 17 Jul 2023 03:13:27 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20221208; t=1689588805; x=1692180805;
        h=content-transfer-encoding:mime-version:user-agent:message-id:date
         :to:from:subject:x-gm-message-state:from:to:cc:subject:date
         :message-id:reply-to;
        bh=4O1ZI33kSqM1Yhtfv63IL7auDzL2Vfn0I4M3Ody7VUw=;
        b=ijbmneWP7sheY1tSC66uUec8uDq/FEJx8w8VoxN0qalETGnE5kqQDFSi7kdwWyURTp
         klEI7OC5l8BPPPcKtuMeW81Yq4mArUiDHpOJmf2YaEcXTMgF38khd0hnqz9GG8/tRqXz
         5+BkJ9Ck7igNXw3LKrhBlDA+wPDz3F92W0KsoAySPxDg3h9ooYVHMKl4GbjA2U3McQ6W
         GaB4SQnCd5IHdEFcTPiqWBBcfiA1PgsDB6IoDS8dzsrRdrg4PEGRo5bnSwSe5yZrJ1Km
         zDLvdUt3Y5m6BI4wmSg08cAiOhfR0xQEokg1MqBCKfytZ+K4OHQSHkphR1uRRLDzSzSC
         C8UQ==
X-Gm-Message-State: ABy/qLaMnn/Sq39BC86626l9sgeWyyU/WbeiMt/MR9dzUs9R6tiFAQd2
        QaLH5+x7VeDN8iAZPUnSyPpk3RtxEIs=
X-Google-Smtp-Source: APBJJlFN6EfMw4QwTnF0OGFy8OTiKhN/uzOr9dB/mt+TkuLNtfCRNLKrbuv7ERMZFciUWxLVn1eh4g==
X-Received: by 2002:adf:dcca:0:b0:313:ed1d:39d5 with SMTP id x10-20020adfdcca000000b00313ed1d39d5mr8508422wrm.35.1689588805373;
        Mon, 17 Jul 2023 03:13:25 -0700 (PDT)
Received: from localhost ([2a0c:5a85:a105:cd00:7813:538a:55d6:7150])
        by smtp.gmail.com with ESMTPSA id a23-20020a5d4577000000b0030ae53550f5sm18763106wrc.51.2023.07.17.03.13.24
        for <netfilter-devel@vger.kernel.org>
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 17 Jul 2023 03:13:25 -0700 (PDT)
Subject: [nft PATCH] tests/build/run-tests.sh: fix issues reported by
 shellcheck
From:   Arturo Borrero Gonzalez <arturo@netfilter.org>
To:     netfilter-devel@vger.kernel.org
Date:   Mon, 17 Jul 2023 12:13:24 +0200
Message-ID: <168958880448.138167.17646583365002263276.stgit@nostromo.nostromo>
User-Agent: StGit/0.19
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 7bit
X-Spam-Status: No, score=-1.4 required=5.0 tests=BAYES_00,
        FREEMAIL_FORGED_FROMDOMAIN,FREEMAIL_FROM,HEADER_FROM_DIFFERENT_DOMAINS,
        RCVD_IN_DNSWL_BLOCKED,RCVD_IN_MSPIKE_H2,SPF_HELO_NONE,SPF_PASS,
        T_SCC_BODY_TEXT_LINE autolearn=no autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <netfilter-devel.vger.kernel.org>
X-Mailing-List: netfilter-devel@vger.kernel.org

Improve a bit the script as reported by shellcheck, also including
information about the log file.

The log file, by the way, is added to the gitignore to reduce noise
in the git tree.

Signed-off-by: Arturo Borrero Gonzalez <arturo@netfilter.org>
---
 .gitignore               |    1 +
 tests/build/run-tests.sh |   34 +++++++++++++++++++---------------
 2 files changed, 20 insertions(+), 15 deletions(-)

diff --git a/.gitignore b/.gitignore
index 6b37b123..d6f17e4f 100644
--- a/.gitignore
+++ b/.gitignore
@@ -16,6 +16,7 @@ libtool
 
 # Generated by tests
 *.payload.got
+tests/build/tests.log
 
 # Debian package build temporary files
 build-stamp
diff --git a/tests/build/run-tests.sh b/tests/build/run-tests.sh
index f78cc901..4616387f 100755
--- a/tests/build/run-tests.sh
+++ b/tests/build/run-tests.sh
@@ -1,32 +1,36 @@
 #!/bin/bash
 
-log_file="`pwd`/tests.log"
+log_file="$(pwd)/tests.log"
 dir=../..
 argument=( --without-cli --with-cli=linenoise --with-cli=editline --enable-debug --with-mini-gmp
 	   --enable-man-doc --with-xtables --with-json)
 ok=0
 failed=0
 
-[ -f $log_file ] && rm -rf $log_file
+[ -f "$log_file" ] && rm -rf "$log_file"
 
 tmpdir=$(mktemp -d)
-if [ ! -w $tmpdir ] ; then
+if [ ! -w "$tmpdir" ] ; then
         echo "Failed to create tmp file" >&2
         exit 0
 fi
 
-git clone $dir $tmpdir >/dev/null 2>>$log_file
-cd $tmpdir
+git clone "$dir" "$tmpdir" >/dev/null 2>>"$log_file"
+cd "$tmpdir" || exit
 
-autoreconf -fi >/dev/null 2>>$log_file
-./configure >/dev/null 2>>$log_file
+if ! autoreconf -fi >"$log_file" 2>>"$log_file" ; then
+	echo "Something went wrong. Check the log '${log_file}' for details."
+	exit 1
+fi
 
-echo  "Testing build with distcheck"
-make distcheck >/dev/null 2>>$log_file
-rt=$?
+if ! ./configure >"$log_file" 2>>"$log_file" ; then
+	echo "Something went wrong. Check the log '${log_file}' for details."
+	exit 1
+fi
 
-if [ $rt != 0 ] ; then
-	echo "Something went wrong. Check the log for details."
+echo  "Testing build with distcheck"
+if ! make distcheck >/dev/null 2>>"$log_file" ; then
+	echo "Something went wrong. Check the log '${log_file}' for details."
 	exit 1
 fi
 
@@ -35,8 +39,8 @@ echo "Build works. Now, testing compile options"
 
 for var in "${argument[@]}" ; do
 	echo "[EXECUTING] Testing compile option $var"
-	./configure $var >/dev/null 2>>$log_file
-	make -j 8 >/dev/null 2>>$log_file
+	./configure "$var" >/dev/null 2>>"$log_file"
+	make -j 8 >/dev/null 2>>"$log_file"
 	rt=$?
 	echo -en "\033[1A\033[K" # clean the [EXECUTING] foobar line
 
@@ -49,7 +53,7 @@ for var in "${argument[@]}" ; do
 	fi
 done
 
-rm -rf $tmpdir
+rm -rf "$tmpdir"
 
 echo "results: [OK] $ok [FAILED] $failed [TOTAL] $((ok+failed))"
 [ "$failed" -eq 0 ]

